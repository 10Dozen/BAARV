<!doctype html>
<html lang="us">
	<head>
		<meta charset="utf-8">
		<title>AAR Converter</title>
		
		<link rel="stylesheet" href="src/css/jquery-ui.css">
		
		<script src="src/js/jquery.min.js"></script>
		<script src="src/js/jquery-ui.min.js"></script>
		
		<style>
			body {				
				margin: 0px;
				padding: 0px;
				font-family: sans-serif;
			}
			
			/* Landing page */
			#header {
				background-color: #3366CC;
				color: white;
			}
			
			#header-title {
				font-size: 24px;
				font-weight: bold;
				padding-left: 40px;
			}
			
			#header-status {
				font-size: 18px;
				background-color: #6798D2;
				padding: 6px 0px 3px 40px;
				
			}
			
			#uploader {
				display: inline;
				padding: 12px 0px 12px 90px;
			}
			
			/* Form */
			#result-form {
				position: absolute;
				top: -1000px;
			}
			.dl-1 {
				display: inline-block;
				width: 150px;
				
				font-size: 15px;
			}
			
			.dl-2 {
				display: inline-block;
				width: 350px;
			}
			
			.dl-2 input {
				width: 350px;
				height: 20px;
				padding: 3px 6px;				
			}
			
			#mission-time, h4 {				
				display: inline-block;
				padding: 1px 5px;
				
				border: 1px solid #6798D2;
				background-color: #6798D2;
				border-radius: 15px;
				font-size: 14px;
				color: white;
			}
			
			.dl-3 {
				display: block;
				width: 500px;
			
			}
			.dl-3 textarea {
				width: 500px;
				padding: 3px 6px;
				font-family: sans-serif;
				
			}
			
			#result-form ul li {
				padding: 3px 0px;
				list-style-type: none;
			}
			
			#player-list {
				font-family: sans-serif;
				font-size: 14px;
			}
			
			#output-generate {
				display: inline-block;
				position: absolute;
				margin-left: 40px;
				width: 100px;
			}
			
			#output-footer textarea {
				display: inline-block;
				margin: 30px 40px;
				position: absolute;				
				width: 510px;			
			}
		</style>
		
		<script>
			var rptData = "";
			// Open file
			var openFile = function(event) { 
				$( "#details-wrapper" ).remove();
				$( "#error-label" ).remove();
				
				var input = event.target; 
				var reader = new FileReader(); 
				reader.onload = function(){ 
					var text = reader.result;
					rptData = text;
					if (text.length > 0) {
						console.log( "Read!");
						if (rptData.search(/<AAR>.*<\/AAR>/) > -1) {
							$( "#header-status > label" ).html( "Ready for convertion!" );
							$( "#header-status" ).css( "background-color", "#9BC34E");
							$( "#uploader-convert" ).removeAttr( "disabled" );
						} else {
							console.log( "Not an AAR!" );
							$( "#header-status > label" ).html( "File does not contain AAR data!" );
							$( "#header-status" ).css( "background-color", "#AF4E4E");
							$( "#uploader-convert" ).attr( "disabled", "true" );
						}
					} else {
						console.log( "Empty!" );
						$( "#header-status > label" ).html( "File is empty/Failed to read!" );
						$( "#header-status" ).css( "background-color", "#AF4E4E");
						$( "#uploader-convert" ).attr( "disabled", "true" );
					}
				};				
				reader.readAsText(input.files[0]);
			};
			
			var aarData, a;
			function convertToAAR() {
				 aarData = {
					"metadata": {
						"island": "",
						"name": "",
						"time": 0,
						"date": "",
						"desc": "",
						"players": [],
						"objects": {
							"units": [],
							"vehs": []					
						}
					},
					"timeline": []
				};
				
				var consoleMsgEnabled = true;
				var consoleDebugEnabled = false;
				function logMsg(t) { if (consoleMsgEnabled) { console.log( t ) }};
				function logDebug(t) { if (consoleDebugEnabled) { console.log( t ) }};
				
				$( "#header-status > label" ).html( "In progress..." );
				
				var rptItems = rptData.match(/<AAR>.*<\/AAR>/ig );
				var metadataCore = JSON.parse( ( rptItems[0].match( /(<core>)(.*)(<\/core>)/i) )[2] ); 
				
				logMsg( "Metadata: Core [ Processing ]" );
				aarData.metadata.island = metadataCore.island;
				aarData.metadata.name = metadataCore.name;
				logMsg( "Metadata: Core [ OK ]" );
				
				logMsg( "Metadata: Units [ Processing ]" );				
				var metadataObjectsRaw = rptData.match( /(<meta><unit>)(.*)(<\/unit><\/meta>)/ig);
				for (var i = 0; i < metadataObjectsRaw.length; i++) {
					var u = JSON.parse( metadataObjectsRaw[i].match( /(<meta><unit>)(.*)(<\/unit><\/meta>)/i)[2] );
					(aarData.metadata.objects.units).push(u.unitMeta);
					if (u.unitMeta[3] > 0) {
						(aarData.metadata.players).push( [u.unitMeta[1],u.unitMeta[2]] );
					}
				}
				logMsg( "Metadata: Units [ OK ]" );
				
				logMsg( "Metadata: Vehicles [ Processing ]" );
				metadataObjectsRaw = rptData.match( /(<meta><veh>)(.*)(<\/veh><\/meta>)/ig);
				for (var i = 0; i < metadataObjectsRaw.length; i++) {
					var u = JSON.parse( metadataObjectsRaw[i].match( /(<meta><veh>)(.*)(<\/veh><\/meta>)/i)[2] );
					(aarData.metadata.objects.vehs).push(u.vehMeta);
				}
				logMsg( "Metadata: Vehicles [ OK ]" );
				
				// Timeline item:	(<\d>)(.*)(<\/\d>)				
				logMsg( "Timeline: Basic [ Processing ]" );
				var timelinesRaw = rptData.match( /(<\d+>)(.*)(<\/\d+>)/ig );
				for (var i = 0; i < timelinesRaw.length; i++) {
					var t = timelinesRaw[i].match( /(<\d+>)(.*)(<\/\d+>)/i );
					var timelabel = t[1].match( /(<)(\d+)(>)/i)[2];
					var unittype = t[2].match( /(<unit>|<veh>)(.*)(<\/unit>|<\/veh>)/i )[1];
					var unitdata = t[2].match( /(<unit>|<veh>)(.*)(<\/unit>|<\/veh>)/i )[2];
					
					if (typeof (aarData.timeline[timelabel]) == "undefined") {
						aarData.timeline[timelabel] = [ [], [], [] ];
					}
					
					switch (unittype) {
						case "<unit>": 
							(aarData.timeline[timelabel])[0].push( JSON.parse(unitdata) );
							break;
						case "<veh>":
							(aarData.timeline[timelabel])[1].push( JSON.parse(unitdata) );
							break;
						case "<atck>":
							(aarData.timeline[timelabel])[2].push( JSON.parse(unitdata) );
							break;
					}
				};
				logMsg( "Timeline: Basic [ OK ]" );
				
				logMsg( "Timeline: Interpolating Transitions of Units [ Processing ]" );
		
				/*
					For each UNIT check all timelines.
						If there are no data for timeline 
						- select last time when data exists then find time when data exists next (or end of time)
						- then for each time between last known and latest time - calculate/interpolate values of position
						- add this data to timeline
						- check for another range				
				*/				
				for (var m = 0; m < 2; m++) {
					var unitList, unitTypeId;

					if (m == 0) {
						unitList = aarData.metadata.objects.units;
						unitTypeId = 0;
					} else {
						unitList = aarData.metadata.objects.vehs;
						unitTypeId = 1;
					}
					
					for (var i = 0; i < unitList.length; i++ ) {
						var unitId = unitList[i][0];
						logDebug("INTERPOLATION FOR UNIT " + unitId);
						
						var lastKnown = [];
						var actualKnown = [];
						var stepsToInterpolate = [];
						for (var j = 0; j < aarData.timeline.length; j++) {
							for (var k = 0; k < aarData.timeline[j][unitTypeId].length; k++) {
								if (aarData.timeline[j][unitTypeId][k][0] == unitId || j == (aarData.timeline.length - 1)) {
									logDebug("Time " + j + " unit data is here! " + aarData.timeline[j][unitTypeId][k]);
									
									if (lastKnown.length == 0) {
										logDebug("Start of Interpol Range");
										lastKnown = aarData.timeline[j][unitTypeId][k];
									} else {
										if (actualKnown.length == 0) {
											logDebug("End of Interpol Range");
											actualKnown = aarData.timeline[j][unitTypeId][k];										
										}
									}
								}
							}
							
							if (lastKnown.length > 0 && actualKnown.length == 0) {
								logDebug("Adding time to empty");
								stepsToInterpolate.push(j);
							} else {
								if (lastKnown.length > 0 && actualKnown.length > 0) {
									logDebug("Interpolation ( @" + lastKnown[1] + ", @" + actualKnown[1] + ", @" + stepsToInterpolate.length + ")");
							
									var posxSteps = interpolateValues( lastKnown[1], actualKnown[1], stepsToInterpolate.length );
									var posySteps = interpolateValues( lastKnown[2], actualKnown[2], stepsToInterpolate.length );
									var dirSteps = interpolateValues( lastKnown[3], actualKnown[3], stepsToInterpolate.length );
								
									logDebug("Interpolation... | X: " + posxSteps + " || Y: " + posySteps + " || DIR: " + dirSteps);								
									// Start with 1, because 0 is equal to lastKnown value and we may not update it
									for (var l = 1; l < stepsToInterpolate.length; l++ ) {
										logDebug( "Time (" + stepsToInterpolate[l] + ")" + [unitId, posxSteps[l], posySteps[l], dirSteps[l], lastKnown[4], lastKnown[5] ] );
									
										if (m == 0) {
											( aarData.timeline[stepsToInterpolate[l]][unitTypeId] ).push( [unitId, posxSteps[l], posySteps[l], dirSteps[l], lastKnown[4], lastKnown[5]]  );
										} else {
											( aarData.timeline[stepsToInterpolate[l]][unitTypeId] ).push( [unitId, posxSteps[l], posySteps[l], dirSteps[l], lastKnown[4], lastKnown[5], lastKnown[6]]  );
										}
									}
								
									lastKnown = [];
									actualKnown = [];
									stepsToInterpolate = [];								
									// Step back to get new start interpolation range
									j = j - 1;
								}
							}
						}
					}
				}
				
				aarData.metadata.time = (aarData.timeline).length - 1;
				logMsg( "Timeline: Interpolating Transitions of Units [ OK ]" );
			
				logMsg( "Creating form" );
				$( "#mission-name" ).val( aarData.metadata.name );
				$( "#mission-island" ).val( aarData.metadata.island );
				$( "#mission-time" ).html( getTimeLabel(aarData.metadata.time) );
				for (var i = 0; i < aarData.metadata.players.length; i++) {
					var color;
					switch (aarData.metadata.players[i][1]) {
						case "blufor": color = "blue"; break;
						case "opfor": color = "red"; break;
						case "indep": color = "green"; break;
						case "civ": color = "purple"; break;
					};
					$( "#player-list" ).append( "<li style='color:" + color + "'>" + aarData.metadata.players[i][0] + "</li>" );				
				}				
				
				console.log(aarData);				
				
				logMsg("Done!");				
				$( "#result-form" ).css( "top", "60px" );
				$( "#header-status > label" ).html( "Converted!" );
				$( ".dl-2 > input, textarea, button" ).removeAttr( "disabled" );
			};
			
			
			// Interpolate values
			function interpolateValues(min,max,steps) {
				var output = [];
				var delta = (max - min)/steps;
				for (var i = 0; i < steps; i++) { output.push( Math.round( min + i*delta ) ); }
				
				return output			
			}
			
			function testInterpolation() {
				console.log( "10...20, 5" + " :: " + interpolateValues(10,20,5));
				console.log( "10...20, 4" + " :: " + interpolateValues(10,20,4));
				console.log( "10...20, 3" + " :: " + interpolateValues(10,20,3));
				console.log( "10...20, 2" + " :: " + interpolateValues(10,20,2));
				console.log( "10...20, 1" + " :: " + interpolateValues(10,20,1));
			}
			
			// Time label
			function getTimeLabel(t) {
				var time = t;
				var timeHours = time / 60 /60 | 0;
				var timeMinutes = (time - timeHours*60*60) /60 | 0;
				var timeSeconds = time - timeHours*60*60 - timeMinutes*60;
				var output = "";
				function formatTimeNum(t,l) {
					var output = t + " " + l + " ";					
					if (t > 0) { 
						if (t < 10) {output = "0" + output;} 
					} else { 
						if (l == "s") {
							output = "00 s"
						} else {
							output = ""
						}
					}
					return output
				}				
				return formatTimeNum(timeHours,"h") + formatTimeNum(timeMinutes,"m") + formatTimeNum(timeSeconds,"s")
			}
			
			
			
			$( document ).ready(function() {
				$( ".dl-2 > input, textarea, button" ).attr( "disabled", "true" );				
			});

		</script>
	</head>
	<body>
		<div id="header">
			<div id="header-title">
				AAR Converter
			</div>
			<div id="header-status">
				<button id="uploader-convert" onClick="convertToAAR()" disabled="true">Convert</button>
				<label>Select RPT file to convert...</label>
				<div id="uploader">
					<input type='file' accept='text/plain' onchange='openFile(event)'>
					
				</div>
			</div>
		</div>
		
		<div id="result-form">
			<ul>
				<li>
					<div class="dl-1">
						Mission name
					</div>
					<div class="dl-2">
						<input id="mission-name"></input>
					</div>
				</li>
				<li>
					<div class="dl-1">
						Island
					</div>
					<div class="dl-2">
						<input id="mission-island"></input>
					</div>
				</li>
				<li>
					<div class="dl-1">
						Date
					</div>
					<div class="dl-2">
						<input id="mission-date" type="date"></input>
					</div>
				</li>
				<li>
					<div class="dl-1">
						Duration
					</div>
					<div class="dl-2">
						<div id="mission-time"></div>
					</div>
				</li>
				<li>
					<div class="dl-1">
						Description:
					</div>
					<div class="dl-3">
						<textarea id="mission-desc" cols="40" rows="5"></textarea>
					</div>
				</li>				
				<li>
					<div class="dl-1">
						<h4>Players</h4>
					</div>
					<ul id="player-list"></ul>
				</li>
			</ul>
			<div id="output-footer">
				<hr />
				<button id="output-generate">Generate</button>		
				<textarea id="output" cols="40" rows="5"></textarea>				
			</div>
		</div>
	</body>
</html>
